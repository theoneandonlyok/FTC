package org.firstinspires.ftc.teamcode;

import com.qualcomm.robotcore.eventloop.opmode.Autonomous;
import com.qualcomm.robotcore.eventloop.opmode.LinearOpMode;
import com.qualcomm.robotcore.hardware.DcMotor;
import com.qualcomm.robotcore.hardware.DcMotorEx;

@Autonomous
public class AutonV3 extends LinearOpMode {
    // Hardware Definitions
    private DcMotorEx outtakeOne, outtakeTwo;
    private DcMotor fl, fr, br, bl;
    private DcMotor intake, tran;

    // Configuration Constants
    private final double DRIVE_POWER = 0.4;
    private final double SHOOT_VELOCITY = -1200;
    private final int ROW_SPACING_TICKS = 900; // Adjust this based on distance between balls

    @Override
    public void runOpMode() {
        // 1. HARDWARE MAPPING
        fl = hardwareMap.get(DcMotor.class, "fl");
        fr = hardwareMap.get(DcMotor.class, "fr");
        bl = hardwareMap.get(DcMotor.class, "bl");
        br = hardwareMap.get(DcMotor.class, "br");
        outtakeOne = hardwareMap.get(DcMotorEx.class, "out1");
        outtakeTwo = hardwareMap.get(DcMotorEx.class, "out2");
        intake = hardwareMap.get(DcMotor.class, "in");
        tran = hardwareMap.get(DcMotor.class, "tran");

        // 2. DIRECTIONS & BRAKING
        fl.setDirection(DcMotor.Direction.FORWARD);
        bl.setDirection(DcMotor.Direction.FORWARD);
        fr.setDirection(DcMotor.Direction.REVERSE);
        br.setDirection(DcMotor.Direction.REVERSE);

        outtakeOne.setDirection(DcMotorEx.Direction.FORWARD);
        outtakeTwo.setDirection(DcMotor.Direction.REVERSE);

        // Set BRAKE mode so the robot stops exactly on the ticks
        fl.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        fr.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        bl.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        br.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);

        // 3. ENCODER RESET
        resetDrivetrainEncoders();
        outtakeOne.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        outtakeTwo.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        outtakeOne.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        outtakeTwo.setMode(DcMotor.RunMode.RUN_USING_ENCODER);

        telemetry.addData("Status", "Ready for 3-Row Auton");
        telemetry.update();

        waitForStart();

        if (opModeIsActive()) {
            // --- STEP 1: SCORE PRELOAD ---
            moveBackward(2000, DRIVE_POWER);
            shootSequence();

            // --- STEP 2: ROW 1 (Closest Ball) ---
            rotateLeft(1900, DRIVE_POWER); // Face the balls
            collectBall(2000);             // Drive forward 1500 ticks while intaking
            moveForward(1500, DRIVE_POWER);
            rotateLeft(1225, DRIVE_POWER); // Face goal
            shootSequence();

            // --- STEP 3: ROW 2 (Middle Ball) ---
            rotateRight(1200, DRIVE_POWER);
            strafeRight(ROW_SPACING_TICKS, DRIVE_POWER);
            collectBall(1500);
            moveForward(1500, DRIVE_POWER);
            strafeLeft(ROW_SPACING_TICKS, DRIVE_POWER);
            rotateLeft(1400, DRIVE_POWER);
            shootSequence();

            // // --- STEP 4: ROW 3 (Furthest Ball) ---
            // rotateLeft(1300, DRIVE_POWER);
            // strafeLeft(ROW_SPACING_TICKS * 2, DRIVE_POWER); // Strafe twice as far
            // collectBall(1500);
            // moveBackward(1500, DRIVE_POWER);
            // strafeRight(ROW_SPACING_TICKS * 2, DRIVE_POWER);
            // rotateRight(1300, DRIVE_POWER);
            // shootSequence();

            // --- STEP 5: PARK ---
            // strafeRight(2500, 0.6);
        }
    }

    // --- SUBSYSTEM METHODS ---

    private void shootSequence() {
        // 1. Spin up the outtake motors
        outtakeOne.setVelocity(SHOOT_VELOCITY);
        outtakeTwo.setVelocity(SHOOT_VELOCITY);
        sleep(2500); // Wait for motors to reach target speed

        // 2. Fire Ball 1
        intake.setPower(0.6);
        tran.setPower(0.6);
        sleep(500);           // Time it takes for one ball to leave

        stopSubsystems();
    }

    private void collectBall(int distance) {
        intake.setPower(0.8);
        tran.setPower(0.3); // Slow transfer helps "lock" the ball in
        moveBackward(distance, 0.3); // Slow speed for better intake grip
        sleep(200);
        intake.setPower(0);
        tran.setPower(0);
    }

    private void stopSubsystems() {
        outtakeOne.setVelocity(0);
        outtakeTwo.setVelocity(0);
        intake.setPower(0);
        tran.setPower(0);
    }

    // --- DRIVETRAIN ENCODER ENGINE ---

    private void moveForward(int ticks, double power) {
        setMove(-ticks, -ticks, -ticks, -ticks, power);
    }

    private void moveBackward(int ticks, double power) {
        setMove(ticks, ticks, ticks, ticks, power);
    }

    private void rotateLeft(int ticks, double power) {
        setMove(-ticks, ticks, -ticks, ticks, power);
    }

    private void rotateRight(int ticks, double power) {
        setMove(ticks, -ticks, ticks, -ticks, power);
    }

    private void strafeLeft(int ticks, double power) {
        // Mecanum math: FL-, FR+, BL+, BR-
        setMove(-ticks, ticks, ticks, -ticks, power);
    }

    private void strafeRight(int ticks, double power) {
        // Mecanum math: FL+, FR-, BL-, BR+
        setMove(ticks, -ticks, -ticks, ticks, power);
    }

    private void setMove(int flT, int frT, int blT, int brT, double power) {
        fl.setTargetPosition(fl.getCurrentPosition() + flT);
        fr.setTargetPosition(fr.getCurrentPosition() + frT);
        bl.setTargetPosition(bl.getCurrentPosition() + blT);
        br.setTargetPosition(br.getCurrentPosition() + brT);

        fl.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        fr.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        bl.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        br.setMode(DcMotor.RunMode.RUN_TO_POSITION);

        fl.setPower(power);
        fr.setPower(power);
        bl.setPower(power);
        br.setPower(power);

        while (opModeIsActive() && fl.isBusy() && fr.isBusy()) {
            telemetry.addData("Moving", "To Position...");
            telemetry.update();
        }

        stopDrivetrain();
    }

    private void stopDrivetrain() {
        fl.setPower(0);
        fr.setPower(0);
        bl.setPower(0);
        br.setPower(0);
        fl.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        fr.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        bl.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        br.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
    }

    private void resetDrivetrainEncoders() {
        fl.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        fr.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        bl.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        br.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        fl.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        fr.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        bl.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        br.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
    }
}
